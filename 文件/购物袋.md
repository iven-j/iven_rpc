# 购物袋梳理

根据liveid获取直播间对应的sku列表以及缓存

目标：一个可视化接口，供内部调用，输入liveid  查询相应的sku列表，以及sku对应的缓存

一个可视化界面，好像前端是jsp

liveid -> sku -> id   

查询，接口？

在

switch > system > util下面  

加个controller, 加个 service 加个 web js 和jsp

入参 liveid

出参 

code 

subCode 

data { skulist,}

## 购物袋研发设计概要

#### 购物袋缓存结构

![img](https://apijoyspace.jd.com/v1/files/dN71qQFr5DYuXCgh5G7F/link)

新购物袋缓存结构主体拆分成三种缓存类型

1.店铺和广告区数据：保留现有结构，缓存在老结构体中；

2.商品列表区拆分成两个数据结构

购物袋索引：购物袋索引通过zset实现，score为业务顺序，value是skuId；如调序，置顶等操作时，通过变更zset中元素的score实现；对C端时，按score从大到小分页输出。

商品详情：每个sku单独存储为一个key。

商品的缓存数据结构是...?

如何查询商品列表以及对sku每个商品缓存进行展示

平时是怎么查询的？查询结果是什么？

返回 and 封装

对缓存进行查询，之后返回，需要对返回数据进行封装

返回值类似那个skulist

先获取skulist，再获取对应sku的缓存

#### 类似功能的接口

[根据skuid批量获取直播中店铺直播间信息接口--batchQueryShopLivingRoom](https://cf.jd.com/pages/viewpage.action?pageId=472959906)

[根据直播间id批量获取专享价商品信息接口](https://cf.jd.com/pages/viewpage.action?pageId=580856684)

[根据直播间id批量获取专享价商品信息接口](https://cf.jd.com/pages/viewpage.action?pageId=580856684)

[直播间购物袋-getShoppingBasketDetail](https://cf.jd.com/pages/viewpage.action?pageId=492174422)





方法：getLiveBaseMsgList

入参： liveId

出参：

```java
Map<String, Object> queryByLiveId(String liveId, String pin){
    
        Map<String, Object> errorMap = new HashMap<>(8);
        //        errorMap.put("code", ResultCode.parameterError.code);
        errorMap.put("code", JsfResultCode.EXCEPTION);
        try {
            if (pin == null) {
                pin = "";
            }
            if (StringUtils.isBlank(liveId)) {
                //                errorMap.put("subCode", "1");
                errorMap.put("subCode", ResultCode.parameterError.code);
                return errorMap;
            }
            Map<String, Object> liveRes = liveShoppingBasket936Service.getShoppingBasketDetail(liveId, pin, null, null, 4);
            liveRes.put("code", JsfResultCode.SUCCESS);
            String resJson = JSON_MAPPER.toJson(liveRes);
            return JSON_MAPPER.fromJson(resJson, HashMap.class);
        } catch (Exception e) {
            errorMap.put("subCode", "3");
            logger.error("购物袋jsf接口错误", e);
            return errorMap;
        }
}

```



```
doGetShoppingBasketResult
入参：liveid liveshow liveskulist

```

新版本緩存讀取

```
bagSkuInfoOpt.batchGetLiveSkus(liveId, paramSkus);
```



全面取消老缓存，采用新缓存，老缓存只做兜底



domain层需要修改

pageinfo考虑要不要入参



1.不确定是输出的是全部还是第一页

2.最好是拉个表格，输出



result.data是一个list,这个该怎么输出怎么分表

List<>

对于livesku来说，可以单个查询livesku.get



之前无法输出的原因是，json文件无法直接打印，需要把json转换为list再输出



##### ？怎么把每个sku信息打印成表格？

1.每个商品信息太多了，是否全部显示

2.如何在前端页面展示表格



在前端展示表格，全部展示

然后在加一个skuid的检索，如果skuid为空，就默认全部检索



在里面套一个if试一试，

存在问题：

1.多次查询会直接贴在后面建表

2.查询skuid没有生效





##### 后续修改

1.sku 查询改成可以查询一堆skulist

2.按照type查询



查其他页面的时候，没有默认刷新页面，保存在默认的之前那页

A：在查询时也重置页面



表头冻结功能

目前不能部署预发，等过会儿再搞



表格疑似没做拉条所以不能固定？





buybtn 2为不显示



```
addCartBtn  2为不显示
```





广告位、搜索栏、店铺不变



商卡部分

![img](https://apijoyspace.jd.com/v1/files/EJPtWtgDDQVwaqAnek2g/link)

遗漏主图区域

图片取商品主数据

状态 skuStatus 下架>无货>正常

下架 是否上下架，或是百补屏蔽商品

无货 区域库存是否有货



1.

角标，置顶爆品，如果好评率>90，展示爆品+好评率

普通商品是序号



2.

讲解按钮：直播间是否能讲解

能讲解看直播间状态

预告根据是否预约展示 已预约或约讲解

直播中 根据讲解状态

讲解中（当没有讲解结束时间 并且 当前时间-直播开始时间-讲解开始时间 < 5min ,则是正在讲解）

看讲解 有vid并且能获取到讲解视频地址

求讲解 其它情况都是求讲解

  回放状态 

看讲解 如果有vid并且能获取到讲解视频地址

不支持讲解，不展示讲解按钮

去提问按钮：功能没有降级，且在直播中



3.

![img](https://apijoyspace.jd.com/v1/files/5SW6J0SvajoT4rPldOvB/link)

业务标签：当是专享价商品，无需展示其业务标签，且以下标签均不展示

百亿补贴 当判断是百亿补贴商品时 并且不是百补屏蔽商品

京东闪播 是闪播专享券商品，并且是未开始和进行中的时候展示，结束阶段不展示标签，直播间状态是预告和直播中，回放状态不打京东闪播

京东秒杀 是秒杀，并且秒杀进行中

预约 是预约商品

预售 是预售商品

超级新品 是超级新品

标题：根据券信息分为一行和两行

一行：有券、且商品和券匹配时

两行：没券或商品和券不匹配



4.

利益点/评论数activity

利益点：先判断是否有利益点

评论数：评论数大于500时展示



5.见prd：https://cf.jd.com/pages/viewpage.action?pageId=1406681987

专享赠标签、倒计时、商品优势

专享赠标签skuTag type=3：是专享赠商品



倒计时skuTag type=2：

专享券闪播：是闪播专享券商品，并且是未开始和进行中的时候展示，结束阶段不展示标签，直播间状态是预告和直播中，回放状态不显示倒计时。通过下发显示最大倒计时，客户端判断是否展示；

限时专享券

专享价



商品优势：自营 > 免息标签 > 物流服务和售后保障



6 价格和优惠券

样式完全依赖商品和券匹配

匹配时：专享券样式(购买按钮展示券)

拍卖和拼购不显示双价格

预约和预售隐藏价格不显示双价格

其它如果有到手价显示双价格，其中主价格是到手价，划线价一般jdprice，预售是currentPrice

健康商品是否可以使用到手价 ??? ->(健康商品分两种，服务和实物，实物都接了到手价，免费问诊属于服务，免费问诊：jdprice，如果拿不到，展示 免费问诊,其他健康商品（京东买药）：到手价>jdprice)

不匹配：普通价格样式 

价格优先级：

​       专享价：如果是未开始状态，双价格，取未来到手价>未来开普勒价>兜底jdprice；

​                     如果是进行中状态，双价格，到手价>开普勒价>兜底jdprice；

百补：是百补屏蔽商品：暂无报价

不是百补屏蔽商品：如果有券展示双价格，如果没有展示jdrpice

预约：隐藏价格：新品待发布

不隐藏价格：到手价 > jdprice

预售：隐藏价格：新品待发布

不隐藏价格：到手价>currentPrice

拍卖：拍卖价格

拼购：拼购价格

到手价

jdprice

​       限流兜底、验资失败非特殊商品都展示jdprice，特殊商品走自己接口拿价格

取不到价格：

免费问诊商品 isJdHealthyProduct：免费问诊 （黑色字体）

最终兜底：暂无报价

价格颜色：

有券：白色文字 #FFFFFF

无券：

大健康：无价格时显示免费问诊 黑色 #1A1A1A

下架、百补限售、区域无货 灰色 #BFBFBF

其它 红色 #FA2C19





7 点击位/加购

商卡整体点击位：

短商 支持类型skuType 0、20、21、22、26

长商

购买按钮显示条件：

不显示购买按钮

百补屏蔽

下架

无货

显示购买按钮，按钮文案见prd：https://cf.jd.com/pages/viewpage.action?pageId=1406681987

优惠券样式：商品和券匹配，不同阶段、状态的优惠券样式见prd

普通样式（单按钮）：

查看：

免费问诊商品(大健康)

拍卖商品

预约

预售

购买：

剩下的商品类型

购买按钮点击效果：

​       专享价已选弹层

​            专享价商品

短结算：

商品上没有券（有券也不匹配）------------待确认

支持已选弹层的基础上

且不支持以下商品

百补限购

下架

预约

预售

无货

拍卖

拼购

促销

万家

B商城

新老到家

大健康

长商：

剩下的商品





加车按钮：

不显示加车按钮

百补商品

下架

无货

预约

预售

免费问诊商品

拍卖

拼购

促销商品

万家

新老到家

定制商品

生旅商品

独立秒杀

到店LOC且不是可加车商品

虚拟商品

特殊二级品类

特殊三级品类

专享价商品





加车按钮类型

普通加车按钮 其他全部商品

专享赠加车按钮 专享赠商品（专享赠作为一种特殊加车商品类型，有不同的加车参数）



有专享券的返回数据

| 业务       | textColorString  | addCartBtn | clickable | clickableTip                 | greyJudgeTime | couponJudgeTime | jumpActionbuttonType | content |
| ---------- | ---------------- | ---------- | --------- | ---------------------------- | ------------- | --------------- | -------------------- | ------- |
| 专享赠     | PRICE_TEXT_WHITE | 1          | 1         |                              | 0             | 0               | 1                    |         |
| 闪播未开始 | PRICE_TEXT_WHITE | 1          | 0         | 活动还未开始，晚点再来享低价 | 1             | 1               | 0                    |         |
| 闪播进行中 | PRICE_TEXT_WHITE | 1          | 1         |                              | 1             | 1               | 1                    |         |
| 闪播结束   | PRICE_TEXT_WHITE | 1          | 1         |                              | 1             | 1               | 1                    |         |
| 秒杀       | PRICE_TEXT_WHITE | 1          | 1         |                              | 0             | 0               | 1                    |         |
| 超级新品   | PRICE_TEXT_WHITE | 1          | 1         |                              | 0             | 0               | 1                    |         |
| 专享券     | PRICE_TEXT_WHITE | 1          | 1         |                              | 0             | 0               | 1                    |         |

price

textColorString highPrice, String addCartBtn, String clickable, String clickableTip, String greyJudgeTime, String couponJudgeTime, String couponActivityKey, String couponContent, String couponChannelType, String couponStatus, String buttonType, String content





发现的差异项：

1.大健康 线上

| 差异   | 线上       | 开发中            |                                                              |
| ------ | ---------- | ----------------- | ------------------------------------------------------------ |
| 大健康 | 线上单价格 | 双价格/可用券价格 | 健康商品分两种，服务和实物，实物都接了到手价，免费问诊属于服务，免费问诊：jdprice，如果拿不到，展示 免费问诊其他健康商品（京东买药）：到手价>jdprice |

 











底层优化

当前单机压测快照

![img](https://apijoyspace.jd.com/v1/files/xam64mASWnsz5NXXCUPg/link)





直播间ID 14272289 13qps

|                                                      |         |            |         |          | 降级效果 |
| ---------------------------------------------------- | ------- | ---------- | ------- | -------- | -------- |
| LiveShow                                             | 1.58 KB | 直播间基础 |         |          |          |
| List<LiveSku>                                        | 132 KB  | 购物袋基础 |         |          |          |
| Map<String, Map<String, String>> skuMainInfos        | 84.7 KB | 主数据     |         |          |          |
| Map<String, Integer> queryCouponTypeMap              | 1.71 KB | 专享券类型 |         |          |          |
| Map<String, PriceResult> realPriceInfos              | 31.3 KB | 实时价格   |         |          |          |
| Map<String, ActivityResult> activityCouponResult     | 13.6 KB | 券领取状态 |         |          |          |
| Map<String, GuideMultiResultModule> skuFinalPriceMap | 111 KB  | 到手价     | 1.5 KB  | 65%->60% | 60%->25% |
| Map<String, SeckillGoodsUnit> seckillGoodsUnitMap    | 16.0 KB | 秒杀信息   |         |          |          |
| Map<String, Map<String, Object>> skuSummarysMap      | 106 KB  | 好评数     | 11.8 KB |          | 无影响   |
| Map<String, Map<String, LabelResult>> labelMap       | 112 KB  | 商品标签   | 4.15 KB |          | 无影响   |
| Map<Long, String> videoMap                           | 3.54 KB | 讲解视频   |         |          |          |
| Map<String, String> shortTitleMap                    | 4.09 KB | 短标题     |         |          |          |
| Map<String, SaleDocsData> interestFree               | 1 KB    | 免息标签   |         |          |          |
| Map<String, String> matchCouponMap                   | 1.73 KB | 券品关系   |         |          |          |



codeview : 

1.券品关系应该放到到手价前面，且到手价校验能不能用券 完成

2.用户是否能领专享券和专享券库存查询，应该放到券品关系后面，如果不能使用，就不查了，存疑

3.券品校验 应该保存不能使用的关系，存疑

4.业务逻辑层，判断闪播专享券时，需要增加券校验，存疑

5.渲染价格的时候，遗漏try/catch  完成

6.价格是Double，需要修改 L783 完成

```
} else if (NumberUtils.isParsable(dto.getJdPrice()) && Long.parseLong(dto.getJdPrice()) > 0) {
```



参考文档：

[购物袋卡片样式v1180](https://cf.jd.com/pages/viewpage.action?pageId=1223297809)

[短商短结开关切量](https://joyspace.jd.com/pages/OclPqfM7pMzHbJfDyJJm)

[购物袋改版1180](https://joyspace.jd.com/sheets/h0gNXlJ4absfvx0wRL4g)





#### 购物袋扩容待确认项目

一.基础部分

1.索引



购物袋活动区域索引 和 购物袋商品索引分成两个 

索引用zset还是list

zset是否可以取一个socre向后取多少条

list是否更合理，list不好保持顺序

zset score ：,其它商品的score是实际序号，不一定是sort，value=skuId

ZRANGEBYSCORE set1 70 90 withscores  limit 索引号 查询的条数 :获取指定索引后的，指定条数数据的键值。

zrevrangebyscore 从高到低

[购物袋扩容索引技术调研](https://joyspace.jd.com/pages/ZGf7cTTasAd3rMl3IzR5)

置顶商品的score是sort=0（或大数），还是单独一个key？

是否可能存在置顶多个？



其它tab怎么分，名字可以改？ 所以还是需要有一个不变的标识关联

(1)直播间分了多少个tab（String？List?hash?）,每个tab数据有名称，有个id 

---- hash cms会不会好操作一些，未来会不会存在子tab开始生效和结束生效时间

(2)tab自己要有一套索引，_liveId_tabId 内部结构同“全部”的索引



高热场次，索引是否应该有多份，或者高热场次有多份？



2.购物袋单品信息

key-value形式 单品单key，String还是Map待讨论（各有优势），String转json 和 Map转属性性能对比需要调研。

活动key和单品key拆开

活动key前缀为 cart_act_{liveid}_{}

单品key前缀为  cart_{liveId}_{skuId}







3.LiveSku各个字段需要再次明确使用范围，各别字段进行优化，如券信息可以增加基础信息

商品卡片基础信息和附属信息的区分







二.影响

一.直播间购物袋接口本身影响

（1）购物袋

活动区域是否跟主购物袋接口放到一起

购物袋置顶是否可以为抽取一条，但抽取一条同屏存在两个相同的品是否存在问题

购物袋锚点是否取消，每次打开购物袋从第1页开始，还是锚定到第N页

客户端购物袋缓存怎么使用

购物袋搜索功能



(2) 讲解列表



(3) 好物抢先看



(4) 公告



（5） M购物袋

https://cf.jd.com/pages/viewpage.action?pageId=303256006

切量：

1.采用灰度发布的方式，以便观察新功能的性能和稳定性。可以根据实际情况逐渐增加灰度发布的比例。（怎么灰度？怎么兼容老版本？）







二.频道内其它使用商品的区域影响

1.列表页

(1) 沉浸式头图商卡

(2)猜你喜欢列表 

主播力荐 ->新主播力荐

置顶直播间 -> 新置顶直播间样式

普通直播间卡片  -> 达人直播间、商品直播间卡片

(3)品类列表

直播间样式卡片

(4)频道推荐列表

（5）boborock推荐列表

（6）鸿蒙负一屏卡片

（7）M兜底列表

 （8）搜索功能



三.对外赋能影响

店铺-影响店铺首页直播间商品召回逻辑

全部购物袋

商详小窗利益点

验资接口









###### 待确认项

1.广告数据(带sku)单独存

广告位数据里面有购物袋商卡相同的sku



2.删除延迟问题(pop商卡问题)

写入和删除的顺序应该是先写或先删品的缓存，再修改索引



3.sku使用hash是否合理

（1）不能跨sku批量获取数据

(2）写入是否也困难？



4 redis本地缓存不支持zset结构，提前识别重点直播间，将key打散

   热点直播间是否有办法预热，减少写入ops



5 购物袋数据去重，方案待确定





6.讲解列表

7.好物抢先看



H5线上协议

https://cf.jd.com/pages/viewpage.action?pageId=303256006

客户端线上协议 

[直播间购物袋分页查询接口（版本待定）](https://joyspace.jd.com/pages/REKoIue1IVLq9Xi7mIKe)

[购物袋卡片样式v12.1.6](https://joyspace.jd.com/pages/o5ZA34dTQZDEADgrA1Ug)



##### 购物袋扩容索引技术调研‘

一.zset



score是sort

value是skuId



```
> zadd test 1 sku1 2 sku2 3 sku3 4 sku4 5 sku5 6 sku6
6

> zrevrangebyscore test +inf -inf withscores
01) sku6
02) 6
03) sku5
04) 5
05) sku4
06) 4
07) sku3
08) 3
09) sku2
10) 2
11) sku1
12) 1

> zrevrangebyscore test +inf -inf withscores limit 0 2
1) sku6
2) 6
3) sku5
4) 5

> zrevrangebyscore test 10000 0 withscores limit 0 2
1) sku6
2) 6
3) sku5
4) 5

> zrevrangebyscore test (5 0 withscores limit 0 2
1) sku4
2) 4
3) sku3
4) 3

> zrevrangebyscore test 4 0 withscores limit 0 2
1) sku4
2) 4
3) sku3
4) 3


liveRedisClient.zRevRangeByScore("test", 0D,Double.MAX_VALUE, 0L, 2L);
```



可行





参考 https://c.biancheng.net/redis2/zrangebyscore.html





# 购物袋扩容研发设计

### 一.购物袋简介

​    直播间购物袋如下图所示，可以分成搜索、功能区、广告区、购物袋分组和商品列表。

| ![img](https://apijoyspace.jd.com/v1/files/qKXw2XwzqgQ5z4W2VVDI/link) | 1.搜索区                                                     | 当前版本购物袋一次下发，客户端通过“商品标题”将匹配到的商品卡片展示出来。 |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 2.功能区                                                     | 1.刷新：重新调用直播间购物袋接口，数据返回后覆盖当前购物袋全部商品列表；2.店铺：由主播配置的广告区店铺信息，提供快捷进入店铺首页的入口；3.购物车/订单：服务端下发jump协议，提供一个快捷进入对应场域的入口。 |                                                              |
| 3.广告区                                                     | 广告区可以配置以下内容：1.商品；2.H5活动入口；3.普通优惠券；4.专享券 |                                                              |
| 4.购物袋分组                                                 | 1.商品分组：由主播配置的，内容范围是全部商品列表，当前由服务端下发各个分组的skuId，由客户端从全部商品列表中获取对应商品卡片数据；2.专享价：商品分组中，专享价是原直播间右侧“专享价”活动，现在通过展示样式的变更，看起来与普通购物袋功能类似。 |                                                              |
| 5.商品列表                                                   | 由主播配置的购物袋商品，在补齐业务逻辑后下发。当前线上没有分页，一次最多下发150条。 |                                                              |



### 二.购物袋直接增加数据量扩容卡点

​    当前购物袋数据在jimdb缓存层为1个店铺数据，10个功能区数据和150个商品数据组成，并存储为单一String结构，在购物袋临近满150个商品时，缓存大小超过100kb。

直接增加商品列表长度的方式扩容会带来一系列问题，导致开天窗风险：

1.缓存大key问题：redis String类型字段超过10KB为大key，当前已经是大key的基础上继续增加大小会加重大key带来的一系列问题；

2.增加上游接口调用量：当前商品数据150个商品是调用完成所有上游接口后在返回，增加数量会直接增加对上游接口的调用量；

3.接口累计响应时长：同问题2，增加调用量的同时会累积更多的响应时长。



| ![img](https://apijoyspace.jd.com/v1/files/oxXu6oFvagVxEUHZu7gf/link) |
| ------------------------------------------------------------ |
| 线上购物袋缓存示意图                                         |



### 三.新缓存结构扩容

新购物袋缓存结构主体拆分成三种缓存类型

1.店铺和广告区数据：保留现有结构，缓存在老结构体中；

2.商品列表区拆分成两个数据结构

购物袋索引：购物袋索引通过zset实现，score为业务顺序，value是skuId；如调序，置顶等操作时，通过变更zset中元素的score实现；对C端时，按score从大到小分页输出。

商品详情：每个sku单独存储为一个key。



| ![img](https://apijoyspace.jd.com/v1/files/dN71qQFr5DYuXCgh5G7F/link) |
| ------------------------------------------------------------ |
| 新购物袋缓存结构示意图                                       |





### 四.新老购物袋缓存结构优缺点

1.老购物袋缓存写入时，需要全集变更；新购物袋商品顺序的变化、单商品数据变化可以独立修改。降低写入时错误覆盖的风险；

2.老购物袋一次加载大量数据，新购物袋分批次加载，可以降低数据吞吐的大小，降低上游接口调用量，提高接口性能；

3.由于新购物袋扩量且分页加载，所以原有遍历全部商品的业务场景需要提前准备其它索引。



### 五.性能升级

购物袋繁多的业务场景和无统筹的依赖调用使得接口耗时长，可以通过技术手段进行优化升级

![img](https://apijoyspace.jd.com/v1/files/JGdKnMh0YE7Ad9EqBMMR/link)



**升级目标**

- 减小接口的请求耗时，提高接口性能，提升用户直播购物体验

#### 1.分层处理

![img](https://apijoyspace.jd.com/v1/files/VyHSoyDBJpEQFJGRKd5f/link)



![img](https://apijoyspace.jd.com/v1/files/G2ZKj9l4HHC44QIpN0ls/link)



分层处理的方式，使得购物袋逻辑更加清晰，增强了可维护性和可扩展性。虽然减少了接口耗时，但并没有达到理想的结果。



#### 2.异步并行

**外部依赖调用分析**

![img](https://apijoyspace.jd.com/v1/files/grQdhE0jUV7ClSag2fSc/link)

升级前：采用串行方式进行调用，耗时为所有依赖调用时长总和，使得接口耗时变长。

升级思路：使用并行方式处理，但外部依赖之间也存在一定的依赖关系，所以决策使用串并行结合的调用方式。单纯根据业务进行并行设计会导致一定的线程浪费，所以参考负载均衡设计思想，将耗时低且有依赖的接口合并到单线程处理，与耗时高的并行处理，充分发挥CPU多核能力。同时设置全局的超时限制，防止影响购物袋主流程。



**异步并行**

![img](https://apijoyspace.jd.com/v1/files/7vkAAxQTgXZwvo8m4WUC/link)





通过上述两个举措，完成购物袋性能升级，接口性能大大提升，TP999从1000左右ms 降低至**200ms以内**，性能提升达**80%+**，大促中支持近**1.5WQPS**，同时保持**100%高可用率**

![img](https://apijoyspace.jd.com/v1/files/ZSL9WwIZPocLOS7OPu9Z/link)





# 大KEY治理

1、大Key的标准： 集合类型元素数量>5000或者单个value大于1M 2、大Key带来风险 •大key发生热点访问，响应积压在服务端后内存暴涨，最终导致服务端被杀造成数据丢失 •严重影响 QPS 、TP99 等指标，对大Key进行的慢操作会导致后续的命令被阻塞，从而导致一系列慢查询。 •hgetall 、 smembers 等时间复杂度O(N)的命令使用不当，容易造成CPU使用率过高。 •集群各分片内存使用不均。某个分片占用内存较高或OOM，发送缓存区增大等，导致该分片其他Key被逐出，同时也会造成其他分片的资源浪费。 •集群各分片的带宽使用不均。某个分片被流控，其他分片则没有这种情况，且影响宿主机上的其它应用。 •数据迁移失败 过大的Key（如超过1G），在迁移、缩容、扩容，主从全量同步在序列化过程中，内存上涨，数据同步失败，且存在 数据丢失风险。 3、大Key治理方案及系统改造建议： •使用SCAN命令进行循序渐进式删除大Key。 •String类型的大Key：可以尝试将对象分拆成几个Key-Value， 使用MGET或者多个GET组成的pipeline获取值，分拆单次操作的压力，对于集群来说可以将操作压力平摊到多个分片上，降低对单个分片的影响。 •集合类型的大Key，并且需要整存整取要在设计上严格禁止这种场景的出现，如无法拆分，有效的方法是将该大Key从JIMDB去除，单独放到其他存储介质上。 •集合类型的大Key，每次只需操作部分元素：将集合类型中的元素分拆。以Hash类型为例，可以在客户端定义一个分拆Key的数量N，每次对HGET和HSET操作的field计算哈希值并取模N，确定该field落在哪个Key上。 4、大Key扫描查看与支持 治理完成后打开JIMDB管理端（http://taishan.jd.com/jimdb/cluster/list），选择拓扑标签页-选择大key扫描 扫描完成后打开大key扫描结果报表查看治理效果http://dashboard.jd.com/element/view/48650 如有问题咨询请加入大Key治理支持咚咚群: 10207069453



## 治理对象

- 集群编号：8911
- 集群名称：LiveRealStatistics
- 大Key明细：http://dashboard.jd.com/element/view/48650?create_time=2023-01-10 00:00:00,2024-12-01 23:59:59&space_id=8_8911
- 待治理key：总计  968个

live_statistics_{liveId}_join  2个    含义：进入直播间人数分时统计，分钟粒度       过期时间：7天

live_real_statistics_result_{liveId}_onlineTotal_1    325个   含义：累计在线人数折线图   过期时间：7天

live_real_statistics_result_{liveId}_onlineuv_1   326个   含义：uv折线图        过期时间：7天

live_real_statistics_result_{liveId}_fansNum_1  315个   含义：新增粉丝数折线图        过期时间：7天



## 产生原因

直播间一直未结束

![img](https://apijoyspace.jd.com/v1/files/uhjuV8TbcdZCI2ulrAVb/link)



## 影响范围

老操控台-直播页面-在线人数折线图

```
1. live_real_statistics_result_xxx ：在线人数分时统计数据结果缓存
JSF数据接口方法：
getRealTimeOnLineData，提供给老操控台核心指标数据展示用，新操控台不再使用
liveReportDataLine，操控台-折线图数据，dataType=uv、pv，还有流量
liveFlowRealDataLine，操控台直播流量看板的折线图数据  dataType=fans_user，dataType=uv，还有流量
使用场景：老实时大屏调用，操控台已经下线

2、live_statistics_{liveId}_join ：在线人数分时统计数据
JSF数据接口方法：getRealTimeOnLineData，老操控台观看人数折线图，新操控台不再使用
```



## 治理计划和方案

1、取消mq消费打点积累分时数据

```
取消消费 topic="live_broadcast"，live_statistics_{liveId}_join key自动过期
```

2、定时任务增加降级开关，并降级

3、观察跟踪老操控台使用情况

4、完成上面3步之后，7天之后，重新扫描大key进一步检查大key情况，对于剩余大key手动清理

5、下线相关代码



## 相关监控

- UMP

1. https://taishan.jd.com/ump/monitor/perfomance?endPointKey=com.jd.live.sw.live.statistics.service.impl.LiveStatisticsServiceImpl.getRealTimeOnLineData&frequency=hour&start_time=1701934828518&end_time=1702539628518
2. https://taishan.jd.com/ump/monitor/perfomance?endPointKey=com.jd.live.sw.live.statistics.service.impl.LiveRealDataServiceImpl.liveReportDataLine
3. https://taishan.jd.com/ump/monitor/perfomance?endPointKey=com.jd.live.sw.live.statistics.service.impl.LiveRealDataServiceImpl.liveFlowRealDataLine&frequency=second&start_time=1706251238317&end_time=1706251538317
4. https://taishan.jd.com/ump/monitor?appId=264241&appName=jdos-live-switch&platform=jdos

​      应用：switch   关键字：com.jd.live.sw.live.statistics.service.impl.LiveStatisticsServiceImpl



- JSF：

https://taishan.jd.com/jsf/interfaceDetail?name=com.jd.live.sw.export.LiveStatisticsService&id=169350



- Jimdb：

https://taishan.jd.com/jimdb/cluster/detail?spaceId=8911&name=Cmd&start=1706137364582&end=1706151764582



引用：

[JIMDB冷数据分析和清理方案](https://joyspace.jd.com/pages/EjJrZcuFXQ6ifJM3y1dE)

[JIMDB大Key删除实践](https://joyspace.jd.com/pages/dygAk39hlkMiE6pnbyTM)





# 核心链路调用关系图

作为补充用一个以下核心模块的最核心接口描述清楚从c到b端调用链路和中间件，表达不同模块的架构和调用关系



- 弹幕：msgFilterV1124



能体现更细的调用关系吗，比如调了什么风控啥的





- 互动—以答题为例

![img](https://apijoyspace.jd.com/v1/files/ABzja63exfclJGuN3ebX/link)



- 购物袋



- 拉流：liveSimpleDetailV1206



- 频道

[猜你喜欢时序图.html](https://apijoyspace.jd.com/v2/pages/HmYPCgc5AQ3MDIXVJLid/files/928Vn3f3KDRzRHnuyGz3/link)

[猜你喜欢时序图.pdf](https://apijoyspace.jd.com/v2/pages/HmYPCgc5AQ3MDIXVJLid/files/4H6iMtyKK3YKE1MH4El6/link)

![img](https://apijoyspace.jd.com/v1/files/4p01meTQbIaaQ2NNqxMl/link)



- 系统架构

![img](https://apijoyspace.jd.com/v1/files/UF7qH15SfscnuzQEVx54/link)



- 部署架构

![img](https://apijoyspace.jd.com/v1/files/5jTs4XnR4fQtbOpFR86y/link)



# 核心关系调用

参考

![img](https://apijoyspace.jd.com/v1/files/ABzja63exfclJGuN3ebX/link)



互动（抽象成一个），拉流，弹幕，交易，频道（关注，精选，推荐）



王棵： 精选，推荐 

精选



推荐：





钱文慧 ：

弹幕：



拉流：





马轩：

 互动时序：

![img](https://apijoyspace.jd.com/v1/files/Gdy9ugbfVGqLAVKe4tGL/link)



关注时序：

![img](https://apijoyspace.jd.com/v1/files/idMk7Cw8S5Gh9DNi7jrG/link)





邵国卿：交易

![img](https://apijoyspace.jd.com/v1/files/TdpsvRBvssn0qxUYEjOv/link)



# 猜你喜欢逻辑

![img](https://apijoyspace.jd.com/v1/files/43lJQumCk3BmAlUmf4Vd/link)





**问题梳理：**

1、兼容老年版，需要保留直播间卡片样式 （历史遗留）

2、分页素材丢失问题（历史遗留）

3、异常数据过滤，比如sku=0，中台同步数据脏数据，未做过滤（新问题，上游影响）

4、流量券支持专享价购物袋sku识别（优化点，之前因为产品没提，未改动）

5、指定直播间坑位顺序异常(已修复，但是把cardId塞到index里这个操作没理解)

6、专享价sku露出时机，应该和购物袋、popup三个场景同步，不能外边有然后里边没有（优化点，最好和其他场景拉齐）



**解决方案：**

1、判别老年版模式，指定下发直播间商卡样式，客户端不兼容商品商卡样式

2、判断当前页的坑位数量，把该数量增加到上限阈值上

3、增加querySku方法结果确认，接口正常返回，但是返回结果中没有信息的sku过滤掉（接口异常和降级的时候如何处理）

4、待确认

5、根据卡片类型，indexMap的key塞不同的数据，直播间卡片-直播间id，商品卡片-sku

6、邀请产品同学一起场景梳理，完善场景展示氛围



**分页素材丢失问题解决方案详述**

1. 问题描述

获取猜你喜欢列表数据主要分为两部分：

- 直播卡片
- 营销位卡片[`banner、主播力荐、指定坑位配置的直播间、主播排位赛、直播流量券`]

第二部分的插入，结果坑位数据处理范围的判断，会带来坑位丢失的问题。

- 素材会漏
- 素材不在指定index上



1. 当前核心代码片段

```
// 获取所有坑位数据
livePitList = cardService.getNewCmsLivePitByPageId(1);
// 坑位数据处理范围
if (livePit.getIndex() >= currentCount 
&& livePit.getIndex() <= currentCount + CardContants.PAGE_LIMIT - 1)
```



1. 解决方案

- 返回结果时，获取当前页下发的坑位数量，下发客户端透传回服务端进行计算：pitcount存缓存

​    （增加pitcount出参，客户端跟currentCount一样回传给我们）

​       缺点：涉及客户端改造，以及没有获取到改字段信息的时候还是存在问题



- 返回结果时，缓存当前页的坑位数量，下次计算获取改数量进行计算

​      缺点：涉及缓存更新和兜底处理，没有获取到改字段信息的时候还是存在问题



- 返回结果中的cardList size，剔除当前页的坑位数量，只返回本身真实的直播间卡片数量：

​    （currentCount改成不包括pitcount的真实列表size）

​      缺点：素材丢失问题解决了，但是index不正确



- 计算当前页范围内坑位数量，然后把坑位素材处理范围，扩大到[`当前页size+当前页范围内坑位数量`]；然后下限阈值，首页0，非首页，修改为上一页处理的最后一个坑位的index与当前页size(pageSize固定值)的较大值。

![img](https://apijoyspace.jd.com/v1/files/osQiLDEcddyNUuRZIPeL/link)

假如，每页获取20条直播卡片，当前页cmd配置素材坑位2个

现在情况：

- 第一页：处理0-20的坑位素材，第一页返回20条直播卡片+2条素材，返回currentCount=22
- 第二页：获取处理的素材，是从>=22开始的处理的，于是21和22两个坑位如果有素材配置，就会丢失



解决方案对比：

- 第一页：获取0-20的坑位数量，比如图中有p1和p2，于是变成处理0-22的坑位素材，如果21和22两个坑位有素材配置，会囊括进来处理掉，并且在第一页返回。于是，第一页返回20条直播卡片+4条素材，返回currentCount=24。

​       --- `解决了index不准的问题(最后的边界还是可能有问题，并且性能存在隐患)`

- 第二页：上一次最后一个pit的坑位的index是22，pageSize=20，所有从>=22开始判断是否有素材。

​       --- `解决了素材丢失的问题`



# 发布时GC

行云发布或者重启的时候频繁的GC，包括YGC 和 FGC

![img](https://apijoyspace.jd.com/v1/files/XvbFQPEeIhHeUXvtkG6c/link)

排查出问题时直播项目本地元空间容量不够，在 default_tomcat_env.sh文件中又设置了默认最大值：-XX:MaxMetaspaceSize=256m  在启动时元空间容量不够，就会频繁的GC



![img](https://apijoyspace.jd.com/v1/files/sTgIQtd0d6jE0y9j8Ad5/link)



更改方式 

目前咱们机器时8C16G的，堆空间设置了8G， 将MetaDumpSize设置为512M(设置成256M 时是不是有GC)，并且不设置上限，当容量不够，就自动扩。

![img](https://apijoyspace.jd.com/v1/files/PGmLBBOxduN5cjfrvVuu/link)



# 线程池监控

## **直播现状:**

1. jvm监控链接：

https://taishan.jd.com/ump/monitor/jvm?key=new_live_soa.jvm&instance=1336944951&host=11.68.136.185&ip=11.68.136.185



1. 大促峰值截图：待补充



**遗留问题：**

**1、队列应该设置多少？可否设置为0**

**2、现有线程池的配置承载上线阈值是多少？**

3、线程数跟线程池配置的核心线程数计算关系？

4、核心线程池默认初始化？



1. 日常截图：

![img](https://apijoyspace.jd.com/v1/files/MzTdz8j66J1oV91RU7SS/link)

cpu使用了很低<10%; 线程数峰值:923; 守护线程数:466;



1. 代码表现：

路径：com.jd.live.soa.common.pool.LiveThreadPool

截图：

![img](https://apijoyspace.jd.com/v1/files/7gQxMfQVEOzROkGLYJa7/link)

线程池分类：

```
1.直播列表线程池  核心线程数100 最大线程数500 队列长度500
2.m直播列表线程池  核心线程数50 最大线程数200 队列长度100
3.直播间上下滑动线程池  核心线程数100 最大线程数500 队列长度500
4.购物袋线程池  核心线程数100 最大线程数200 队列长度100
5.直播间新公告区线程池  核心线程数100 最大线程数200 队列长度100
```

1. 耗时统计：

https://taishan.jd.com/pfinder/callchain/traceid?appName=jdos-new-live-soa&methodId=162151787&ip=all&componentId=&protocol=all&error=false&startTime=1707112907399&endTime=1707113807399&pfinderAuth=true



![img](https://apijoyspace.jd.com/v1/files/BqaINxu5jKnqzkGCYADr/link)



![img](https://apijoyspace.jd.com/v1/files/mWH0NzADQbtlfxgD9FoU/link)

Jsf、jimdb、网络io占用了大部分的时间，图中大概是5:1的比例，不同的请求可能比例有所变化，但是整体趋势呈现的是：io的时间基本都是大于本地代码执行时间。但是其实还有一个特殊情况，GC时间，当大流量过来的时候，像到手价返回的大对象，也会导致cpu飙升的现象。





## **问题**

- 线程池配置是否合理
- 与qps的换算关系
- 每台机器应该目前能抗住多少qps
- 每个场景需要多少qps，多少线程够用
- 流量激增，线程数激增，目前配置是否会导致oom
- 往年被执行拒绝策略的请求有多少
- 满足多大流量的场景（极限CPU利用率、内存使用率）





## **业务场景分析**

- 购物袋：业务分类：到手价、商品库存、科技广告数据  *3  

![img](https://apijoyspace.jd.com/v1/files/0KKODyshm4IK53LKFrGU/link)

- 猜你喜欢列表：业务分类，跟cms配置坑位相关，最多6种坑位配置  *6  

![img](https://apijoyspace.jd.com/v1/files/NXPOf7fhvUWpAbDxQOMF/link)

- 直播频道列表：同猜你喜欢   *6     
- 气泡：走购物袋逻辑，所以多线程同购物袋   *3   
- 上下滑动：逻辑分类：有券、无券算法调用，获取直播间推荐信息   *2

![img](https://apijoyspace.jd.com/v1/files/gQV0LH9EdZG4GnidA9EU/link)

- 公告：业务分类：好价、好券，分别处理各自的data  *2

![img](https://apijoyspace.jd.com/v1/files/69iDQEAQRnQWRizhXbxj/link)



峰值统计：

- 购物袋                 日常qps：200       20231111峰值qps：7695
- 猜你喜欢列表      日常qps：50       20231111峰值qps：459
- 直播频道列表      日常qps：10       20231111峰值qps：42
- 气泡                    日常qps：200       20231111峰值qps：7695
- 上下滑动             日常qps：150       20231111峰值qps：2540
- 公告                     日常qps：10       20231111峰值qps：2314





## **技术调研**

> https://jade.jd.com/executor
> http://xingyun.jd.com/shendeng/article/detail/13196
> http://xingyun.jd.com/shendeng/article/detail/9329
> http://xingyun.jd.com/shendeng/article/detail/9600

1、队列满了之后的新任务，新建线程先执行，还是队列里的任务先执行

​     队列满了之后，这时候有新任务到来的话，新建非核心线程来处理任务。不会先处理队列里的任务，把新任务压进队列队尾

![img](https://apijoyspace.jd.com/v1/files/CuD5swmYe7wgFoQFDrzn/link)

​      参考：

https://blog.csdn.net/c10WTiybQ1Ye3/article/details/109684791

https://blog.csdn.net/qq_42799615/article/details/113738852

2、触发拒绝策略的条件

​    当提交任务数大于 corePoolSize 的时候，会优先将任务放到 workQueue 阻塞队列中。当阻塞队列饱和后，会扩充线程池中线程数，直到达到 maximumPoolSize 最大线程数配置。此时，再多余的任务，则会触发线程池的拒绝策略了。总结起来，也就是一句话，当提交的任务数大于（workQueue.size() + maximumPoolSize ），就会触发线程池的拒绝策略。





## **理论规划线程数**

1. 可能很多人都看到过一个线程数设置的理论：

> CPU 密集型的程序 - 核心数 + 1
> I/O 密集型的程序 - 核心数 * 2



1. 《Java 并发编程实战》介绍了一个线程数计算的公式：

![img](https://apijoyspace.jd.com/v1/files/ZafVqReZKiLgirGRip88/link)![img](https://apijoyspace.jd.com/v1/files/cfNVvvJgekkxs6nXXspa/link)



1. 公式变形：

需要线程数 = cpu核心数 * cpu目标利用率 * (1 + io时间(即cpu等待时间)/cpu计算时间)







## **接入万象平台组件**

存在现有的平台组件，支持线程池监控和动态更改核心配置参数，详情https://jade.jd.com/executor.html



1. 线程池监控

线程池配置：

```
/**
 * 线程池监控
*/
public static final Executor LIVE_NOTICE_POOL_MONITOR = ThreadPoolExecutorBuilder.newBuilder()
        .setName("liveNoticePoolMonitor")
        .setCorePoolSize(10)
        .setMaxPoolSize(20)
        .setQueueCapacity(10)
        .setRejectPolicy(RejectedExecutionHandlers.RejectPolicy.CALLER_RUNS)// 拒绝策略内置监控、日志
        .pfinderDecorated(true)  // pfinder异步跟踪
        .prestart()  // 预初始化所有核心线程
        .build();
```



调用日志：

![img](https://apijoyspace.jd.com/v1/files/yBwLMMqJtY4NHCoQh8UX/link)





线程池监控截图

https://taishan.jd.com/pfinder/multi-dimension?tag=business&appName=jdos-live-switch&platform=jdos&unit=all&metric=executor

![img](https://apijoyspace.jd.com/v1/files/NBDLgUNECUEmA9y7n9P6/link)

核心线程监控图：

![img](https://apijoyspace.jd.com/v1/files/bVVpy1PfgeYkyUVUKTp8/link)

拒绝策略执行监控图：

![img](https://apijoyspace.jd.com/v1/files/LfuCj1fUWL8mLN4HcxgG/link)



1. 线程池核心参数动态调整

ducc配置路径：

https://taishan.jd.com/ducc/web/namespacework?nsId=6072&nsName=live_app&cId=840578&cName=jade&envId=1012755&envName=production&defAppId=7257&dataType=0

动态调整：

![img](https://apijoyspace.jd.com/v1/files/3pV9QCcjvvZNLs8lpK7t/link)

动态调整成功：

![img](https://apijoyspace.jd.com/v1/files/EXCCe7bz5XUS7Zzneg4S/link)



默认拒绝策略验证（线上也是默认拒绝策略）：

AbortPolicy - 丢弃任务，并抛出拒绝执行 RejectedExecutionException 异常信息。

![img](https://apijoyspace.jd.com/v1/files/IDo0ANjp63fktB7dvhMM/link)



## **后续计划**

1、分场景重新确定各自的核心参数配置   根据qps预估

2、分场景压测调整得到最优配置

3、new-live-soa逐步切换为万象线程池配置，便于监控和动态调整



## **使用情况**

https://taishan.jd.com/pfinder/multi-dimension?tag=business&appName=jdos-live-switch&platform=jdos&unit=all&metric=executor

![img](https://apijoyspace.jd.com/v1/files/Bp7uOqj2QYvKp6LRPEB4/link)



JSF线程池



自定义线程池



# 直播实验

# 实验一：关注tab新版样式实验

## 实验背景

prd文档：[关注tab改版优化升级](https://joyspace.jd.com/pages/7K0xBCkm4toCV1PZQimA)

实验方案：实验组 20%，对照组 80% 

| 实验分组 | 详情                                                  | demo                                                         |
| -------- | ----------------------------------------------------- | ------------------------------------------------------------ |
| 对照组   | 线上样式                                              | ![img](https://apijoyspace.jd.com/v1/files/3ubuBiIYW1M01A5Lapkg/link) |
| 实验组   | 最爱主播改成顶部横条样式；我的关注改成双 feeds 样式； | ![img](https://apijoyspace.jd.com/v1/files/U6l3CbK2HvDx1B9XFzHf/link) |

## 实验结论总结

## **初步结论**

- 用户在使用关注Tab时，主要以寻找关注的主播为主要需求，其次才是探索新内容。
- 新版样式在提升某些业绩指标的同时，也带来了用户体验的下降，尤其是在方便性和直观性方面。

## **思考与建议**

1. **优化方向：**在追求业绩指标提升的同时，需要平衡用户体验，特别是要保证用户能轻松找到关注的主播。
2. **调整策略：**考虑在新版样式中重新强化主播信息的展示，同时保留算法优化带来的正面效果。
3. **用户引导：**对于界面的变化，提供更明确的指引和说明，减少用户的误解和不便感。

## **数据分析**

### 方法

采用hash算法，按uuid维度进行灰度测试，对比新老样式的表现。

### 4月10日~5月1日

[Normal]正向指标

直播频道关注tab新样式的用户点击率(UCTR)正向提升，特别是关注主播模块UCTR **+15%**

[Risk]负向指标

人均浏览时长 **-5%**，人均VV(视频观看次数) **-14%**，转化率 **-7%**

> 结论：直播卡片尺寸变小、WiFi环境下自动播放功能增强了用户点击意愿，但主播信息的弱化导致用户难以找到关注的主播，影响了观看次数和时长。

### 5月1日~至今

[Normal]维持指标

人均停留时长持平

[Risk]改进指标

人均VV减少，但成交订单转化率 **+3%**

> 结论：新版通过算法优化feed流，虽然主播识别度下降，但更精准的内容匹配提高了转化率。

## **用户反馈**

主要负面反馈集中在新界面的不便利性，尤其是关注的直播间难以找到，界面变化引起的不适应。

## **用研分析**

- 用户感觉操作路径变长，新版界面减少了直观性和方便性。
- 用户对于界面类别的变化存在误解，认为关注的直播间被隐藏。

# 实验二：视频tab露出实验

## 实验背景

prd文档：[直播和视频顶部通栏能力](https://joyspace.jd.com/pages/CFaH7m3zVaC3HEWm8eL8)

实验方案：实验组 30%，对照组 70% 

| 实验分组 | 详情                 | demo                                                         |
| -------- | -------------------- | ------------------------------------------------------------ |
| 对照组   | 线上样式             | ![img](https://apijoyspace.jd.com/v1/files/xoR7EFe8EUjvTRPKzcXY/link) |
| 实验组   | 顶部导航增加视频 tab | ![img](https://apijoyspace.jd.com/v1/files/w9DolbjxMrdJYtS8CERw/link) |

## 实验结论总结

## **核心结论**

人均停留时长**+22%**，视频TAB能显著提升那些已有关注习惯并且查看过推荐内容的核心用户的浏览时长。

## **思考**

建议扩量观察

## **方法**

采用hash算法，按uuid维度进行灰度测试。对比不露出和露出的表现

## **数据分析**

对比**有浏览过视频**且**浏览过关注、推荐TAB页**的用户与**未浏览过视频**但**浏览过关注、推荐TAB页**的用户，发现前者的人均停留时长**+22%**。

# 实验三：短结实验

## 实验背景

prd文档：[内容域"立即购买按钮"组件接入短结算](https://joyspace.jd.com/pages/p79lg0akrkDJ0mx8Vz8G)

实验方案：实验组A 5%，实验组B 75%，对照组 20% 

| 实验分组 | 详情               | demo                                                         |
| -------- | ------------------ | ------------------------------------------------------------ |
| 对照组   | 线上样式，跳商详页 |                                                              |
| 实验组A  | A版短结算          | ![img](https://apijoyspace.jd.com/v1/files/rTKWQSEWCzI11F4sWLiQ/link) |
| 实验组B  | B版短结算          | ![img](https://apijoyspace.jd.com/v1/files/kiudM9IOmNDJ2OgdJvu4/link) |

## 实验结论总结

- **核心结论**
  - **实验表明**虽然短结算在整体上略有提升成交订单转化率，但其对于简化购买流程的效果有限，特别是在耗时方面。
  - **品类差异**显示，短结算在某些品类中能有效提升转化率，而在其他品类则可能影响负面，这可能与品类特性和用户购买行为有关。
- **建议**
  - 继续观察并收集数据，尤其是对耗时较长的原因进行深入分析。
  - 考虑对不同品类采取不同的短结算策略，或在用户体验和购买决策信息提供上进行优化。
  - 可以开展更细分的A/B测试，针对不同品类和用户群体，以更准确地评估短结算的效果并作出相应调整。

## **13.0.2 版本更新**

截至5月23日，APP版本13.0.2的更新率达到`76.7%`

## **数据分析**

1. **整体表现**

- A版实验切量：5%
- 直播间点击去购买UV：18万
- 成交订单转化率：17.5%，相较于短结算B版本及纯对照组均 **+0.1** 百分点(pp)。
- 用户购买耗时：A版短结算用户耗时最长，B版次之。

结论：短结算对于简化用户购买链路的影响有限，建议进一步观测数据。

1. **品类分析**

- 正向影响品类：母婴、美妆、食品饮料、宠物生活等品类的A版短结算转化效率呈正向。
- 负向影响品类：家电、数码、家庭清洁等品类的转化率为负向。

结论：短结算对不同品类的影响存在显著差异，需考虑是否能在用户体验和购买决策信息层面有效支持用户完成购买。

[直播短结算数据.xlsx](https://apijoyspace.jd.com/v2/pages/ChkZGraN3739b194R5NM/files/snFOvinckcU3K4ZP9vBo/link)

# 实验四：看赚icon露出实验（10%，待补充）

![img](https://apijoyspace.jd.com/v1/files/F3otvznyu7oGSRTCsMex/link)

# 实验六：购物车购买按钮0元试用文案实验（24号放量，待补充）

![img](https://apijoyspace.jd.com/v1/files/bOUYAooMpJ3dqRAxPWp9/link)



实验数据分析：http://ab.jd.com/api/short/get/prod?key=bO6

# 实验七：购物车置顶商卡实验（24号放量，待补充）
